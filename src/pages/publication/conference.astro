---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { MarkdownInstance } from "astro";

type FM = {
  title: string;
  authors?: string;
  venue?: string;
  year: number;
  scope?: "International" | "Domestic";
  pdf?: string;
  link_url?: string;
  preprint_url?: string;
  github_url?: string;
};

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/publication/conference/*.md");
const items = await Promise.all(Object.values(modules).map((fn) => fn()));

const normScope = (s?: FM["scope"]) => (s === "Domestic" ? "Domestic" : "International");

const byYear = new Map<number, { International: MarkdownInstance<FM>[]; Domestic: MarkdownInstance<FM>[] }>();

for (const it of items) {
  const y = it.frontmatter.year ?? 0;
  if (!byYear.has(y)) byYear.set(y, { International: [], Domestic: [] });
  byYear.get(y)![normScope(it.frontmatter.scope)].push(it);
}

const years = Array.from(byYear.keys()).sort((a, b) => b - a);

for (const y of years) {
  for (const k of ["International", "Domestic"] as const) {
    byYear.get(y)![k].sort((a, b) => (a.frontmatter.title ?? "").localeCompare(b.frontmatter.title ?? ""));
  }
}
---

<BaseLayout title="Conference">
  <h1>Conference</h1>

  {years.map((y) => {
    const g = byYear.get(y)!;
    return (
      <section class="pub-year">
        <div class="pub-year-left">{y}</div>

        <div class="pub-year-right">
          {g.International.length > 0 && (
            <>
              <h2 class="pub-section">International </h2>
              <div class="pub-items">
                {g.International.map((it) => (
                  <article class="pub-item">
                    <div class="pub-title">{it.frontmatter.title}</div>
                    <div class="pub-meta">
                      {it.frontmatter.authors && <span>{it.frontmatter.authors}</span>}
                      {it.frontmatter.venue && <span> 路 <em>{it.frontmatter.venue}</em></span>}
                      <span> 路 {it.frontmatter.year}</span>
                    </div>

                    <div class="pub-actions">
                      {it.frontmatter.preprint_url && <a class="pub-btn" href={it.frontmatter.preprint_url} target="_blank" rel="noreferrer">preprint</a>}
                      {it.frontmatter.link_url && <a class="pub-btn" href={it.frontmatter.link_url} target="_blank" rel="noreferrer">link</a>}
                      {it.frontmatter.github_url && <a class="pub-btn" href={it.frontmatter.github_url} target="_blank" rel="noreferrer">GitHub</a>}
                      {it.frontmatter.pdf && <a class="pub-btn" href={it.frontmatter.pdf} download>PDF</a>}
                    </div>
                  </article>
                ))}
              </div>
            </>
          )}

          {g.Domestic.length > 0 && (
            <>
              <h2 class="pub-section">Domestic </h2>
              <div class="pub-items">
                {g.Domestic.map((it) => (
                  <article class="pub-item">
                    <div class="pub-title">{it.frontmatter.title}</div>
                    <div class="pub-meta">
                      {it.frontmatter.authors && <span>{it.frontmatter.authors}</span>}
                      {it.frontmatter.venue && <span> 路 <em>{it.frontmatter.venue}</em></span>}
                      <span> 路 {it.frontmatter.year}</span>
                    </div>

                    <div class="pub-actions">
                      {it.frontmatter.preprint_url && <a class="pub-btn" href={it.frontmatter.preprint_url} target="_blank" rel="noreferrer">preprint</a>}
                      {it.frontmatter.link_url && <a class="pub-btn" href={it.frontmatter.link_url} target="_blank" rel="noreferrer">link</a>}
                      {it.frontmatter.github_url && <a class="pub-btn" href={it.frontmatter.github_url} target="_blank" rel="noreferrer">GitHub</a>}
                      {it.frontmatter.pdf && <a class="pub-btn" href={it.frontmatter.pdf} download>PDF</a>}
                    </div>
                  </article>
                ))}
              </div>
            </>
          )}
        </div>
      </section>
    );
  })}
</BaseLayout>
