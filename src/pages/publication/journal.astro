---
import SectionLayout from "../../layouts/SectionLayout.astro";
import type { MarkdownInstance } from "astro";

const nav = [
  { label: "Journal", href: "/publication/journal/" },
  { label: "Conference", href: "/publication/conference/" },
];

type FM = Record<string, any>;
const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/publication/journal/*.md");

const items = await Promise.all(
  Object.entries(modules).map(async ([path, loader]) => {
    const entry = await loader();
    const slug = path.split("/").pop()?.replace(/\.md$/, "") ?? path;
    const fm = entry.frontmatter ?? {};
    const year =
      fm.year ??
      (typeof fm.date === "string" ? Number(String(fm.date).slice(0, 4)) : undefined) ??
      (typeof fm.published === "string" ? Number(String(fm.published).slice(0, 4)) : undefined);

    const scopeRaw = (fm.scope ?? fm.type ?? fm.category ?? fm.region ?? "").toString().toLowerCase();
    const scope = scopeRaw.includes("domestic") || scopeRaw.includes("국내") ? "Domestic" : "International";

    return { slug, entry, fm, year: year ?? 0, scope };
  })
);

items.sort((a, b) => (b.year ?? 0) - (a.year ?? 0));

const byYear = new Map<number, { International: typeof items; Domestic: typeof items }>();
for (const it of items) {
  const y = it.year ?? 0;
  if (!byYear.has(y)) byYear.set(y, { International: [], Domestic: [] });
  byYear.get(y)![it.scope].push(it);
}

const years = Array.from(byYear.keys()).sort((a, b) => b - a);
---

<SectionLayout title="Journal" sectionLabel="PUBLICATION" navItems={nav} heroSrc="/images/sub-hero.jpg">
  <h1>Journal</h1>

  <div style="margin-top:18px;">
    {years.map((y) => {
      const grp = byYear.get(y)!;
      return (
        <section class="pub-year">
          <div class="pub-year-left">{y || "—"}</div>

          <div>
            {grp.International.length > 0 && (
              <div class="pub-block">
                <div class="pub-section">International</div>
                <div class="pub-items">
                  {grp.International.map(({ entry }) => {
                    const fm = entry.frontmatter ?? {};
                    const title = fm.title ?? fm.paperTitle ?? fm.name ?? "Untitled";
                    const meta =
                      fm.meta ??
                      fm.authors ??
                      fm.journal ??
                      fm.venue ??
                      fm.citation ??
                      fm.description ??
                      "";
                    const link = fm.link ?? fm.url ?? fm.doi ?? "";

                    return (
                      <div class="pub-item">
                        <div class="pub-title">{title}</div>
                        {meta && <div class="pub-meta">{meta}</div>}
                        {link && (
                          <div style="margin-top:6px;">
                            <a class="pub-btn" href={link} target="_blank" rel="noreferrer">
                              Link
                            </a>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {grp.Domestic.length > 0 && (
              <div class="pub-block">
                <div class="pub-section">Domestic</div>
                <div class="pub-items">
                  {grp.Domestic.map(({ entry }) => {
                    const fm = entry.frontmatter ?? {};
                    const title = fm.title ?? fm.paperTitle ?? fm.name ?? "Untitled";
                    const meta =
                      fm.meta ??
                      fm.authors ??
                      fm.journal ??
                      fm.venue ??
                      fm.citation ??
                      fm.description ??
                      "";
                    const link = fm.link ?? fm.url ?? fm.doi ?? "";

                    return (
                      <div class="pub-item">
                        <div class="pub-title">{title}</div>
                        {meta && <div class="pub-meta">{meta}</div>}
                        {link && (
                          <div style="margin-top:6px;">
                            <a class="pub-btn" href={link} target="_blank" rel="noreferrer">
                              Link
                            </a>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </section>
      );
    })}

    {items.length === 0 && <p class="muted">No journal publications yet.</p>}
  </div>
</SectionLayout>
