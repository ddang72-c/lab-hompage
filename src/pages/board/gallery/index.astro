---
import SectionLayout from "../../../layouts/SectionLayout.astro";
import GalleryPost from "../../../components/gallery/GalleryPost.tsx";
import type { MarkdownInstance } from "astro";

type FM = Record<string, any>;

const toImageUrls = (fm: any): string[] => {
  const out: string[] = [];
  const push = (x: any) => {
    if (typeof x === "string" && x.trim()) out.push(x.trim());
  };
  const readList = (arr: any[]) => {
    for (const it of arr) {
      if (typeof it === "string") push(it);
      else if (it && typeof it === "object") push(it.photo ?? it.image ?? it.src ?? it.url);
    }
  };

  if (Array.isArray(fm?.images)) readList(fm.images);
  if (Array.isArray(fm?.photos)) readList(fm.photos);
  if (Array.isArray(fm?.gallery)) readList(fm.gallery);
  if (Array.isArray(fm?.media)) readList(fm.media);

  push(fm?.cover);
  push(fm?.thumbnail);
  push(fm?.thumb);

  return Array.from(new Set(out));
};

const toFeaturedIndex = (fm: any): number | null => {
  const raw = fm?.featuredIndex ?? fm?.featured_index ?? null;
  if (raw === null || raw === undefined) return null;
  const n = Number(raw);
  if (!Number.isFinite(n)) return null;
  return Math.max(0, Math.floor(n));
};

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");

const posts = await Promise.all(
  Object.entries(modules).map(async ([, loader]) => {
    const entry = await loader();
    const fm = entry.frontmatter ?? {};
    const title = (fm.title ?? "Untitled").toString();
    const dateStr = (fm.date ?? fm.published ?? fm.created ?? "").toString();
    const date = dateStr ? new Date(dateStr) : null;
    const images = toImageUrls(fm);
    const featuredIndex = toFeaturedIndex(fm);

    // (선택) 게시물 단위 정책: auto | cover | contain
    const fit = (fm.fit ?? "auto").toString();

    return { title, date, images, featuredIndex, fit };
  })
);

posts.sort((a, b) => {
  const ad = a.date ? a.date.getTime() : 0;
  const bd = b.date ? b.date.getTime() : 0;
  if (ad !== bd) return bd - ad;
  return a.title.localeCompare(b.title);
});

const fmt = (d: Date | null) => (d ? d.toISOString().slice(0, 10) : "");
---

<SectionLayout title="Gallery">
  <style is:global>
    {`
      .gallery-list{
        display:grid;
        gap: 56px;
        margin-top: 18px;
      }
      .gallery-post{
        padding-bottom: 28px;
        border-bottom: 1px solid var(--line, #eee);
      }
      @media (max-width: 640px){
        .gallery-list{ gap: 44px; }
      }
    `}
  </style>

  <div class="gallery-list">
    {posts.map((p) => (
      <div class="gallery-post">
        <GalleryPost
          client:load
          title={p.title}
          date={fmt(p.date)}
          images={p.images}
          featuredIndex={p.featuredIndex}
          fit={p.fit}
        />
      </div>
    ))}
  </div>
</SectionLayout>
