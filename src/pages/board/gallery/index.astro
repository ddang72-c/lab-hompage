---
import SectionLayout from "../../../layouts/SectionLayout.astro";
import type { MarkdownInstance } from "astro";

const nav = [
  { label: "News", href: "/board/news/" },
  { label: "Gallery", href: "/board/gallery/" },
];

type FM = Record<string, any>;
const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");

const items = await Promise.all(
  Object.entries(modules).map(async ([path, loader]) => {
    const entry = await loader();
    const slug = path.split("/").pop()?.replace(/\.md$/, "") ?? path;
    const fm = entry.frontmatter ?? {};
    const title = fm.title ?? "Untitled";
    const cover = fm.cover ?? fm.thumbnail ?? fm.thumb ?? "";
    const dateStr = (fm.date ?? fm.published ?? fm.created ?? "").toString();
    const date = dateStr ? new Date(dateStr) : null;
    return { slug, entry, fm, title, cover, date };
  })
);

items.sort((a, b) => {
  const ad = a.date ? a.date.getTime() : 0;
  const bd = b.date ? b.date.getTime() : 0;
  if (ad !== bd) return bd - ad;
  return a.title.localeCompare(b.title);
});
---

<SectionLayout title="Gallery" sectionLabel="BOARD" navItems={nav} heroSrc="/images/sub-hero.jpg">
  <h1>Gallery</h1>

  <div class="gallery-grid" style="margin-top:18px;">
    {items.map(({ slug, title, cover }) => (
      <a class="gallery-card" href={`/board/gallery/${slug}/`}>
        <div class="thumb">
          {cover ? (
            <img src={cover} alt={title} loading="lazy" />
          ) : (
            <div class="thumb-empty">No image</div>
          )}
        </div>
        <div class="g-info">
          <div class="g-title">{title}</div>
        </div>
      </a>
    ))}
  </div>

  {items.length === 0 && <p class="muted" style="margin-top:18px;">No gallery posts yet.</p>}
</SectionLayout>
