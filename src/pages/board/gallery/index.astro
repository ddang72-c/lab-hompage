---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { MarkdownInstance } from "astro";

type ImageItem = string | { image: string };
type FM = { title: string; date?: string | Date; images?: ImageItem[] };

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");
const posts = await Promise.all(Object.values(modules).map((fn) => fn()));

posts.sort(
  (a, b) => new Date(b.frontmatter.date ?? 0).getTime() - new Date(a.frontmatter.date ?? 0).getTime()
);

const slugOf = (p: MarkdownInstance<FM>) => p.file.split("/").pop()!.replace(/\.md$/, "");

const firstImage = (images?: ImageItem[]) => {
  const v = images?.[0];
  if (!v) return "";
  return typeof v === "string" ? v : v.image;
};
---

<BaseLayout title="Gallery">
  <h1>Gallery</h1>

  <div class="gallery-grid">
    {posts.map((p) => {
      const slug = slugOf(p);
      const thumb = firstImage(p.frontmatter.images);

      return (
        <a class="gallery-card" href={`/board/gallery/${slug}`}>
          <div class="thumb">
            {thumb ? (
              <img src={thumb} alt={p.frontmatter.title} loading="lazy" />
            ) : (
              <div class="thumb-empty">No Image</div>
            )}
          </div>

          <div class="g-info">
            <div class="g-title">{p.frontmatter.title}</div>
            {p.frontmatter.date && (
              <div class="muted">{new Date(p.frontmatter.date).toLocaleDateString()}</div>
            )}
          </div>
        </a>
      );
    })}
  </div>
</BaseLayout>
