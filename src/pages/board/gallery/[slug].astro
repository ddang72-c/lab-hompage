---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { MarkdownInstance } from "astro";

type ImageItem = string | { image: string };
type FM = { title: string; date?: string | Date; images?: ImageItem[] };

const first = (imgs?: ImageItem[]) => {
  const v = imgs?.[0];
  if (!v) return "";
  return typeof v === "string" ? v : v.image;
};

const toUrls = (imgs?: ImageItem[]) =>
  (imgs ?? []).map((v) => (typeof v === "string" ? v : v.image)).filter(Boolean);

// ✅ 1) 여기서 1번만 선언 (modules → galleryModules로 이름도 바꿔서 충돌 방지)
const galleryModules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");

export async function getStaticPaths() {
  // ✅ 2) slug는 path에서 만든다 (entry.file 의존 X)
  return Object.keys(galleryModules).map((path) => ({
    params: { slug: path.split("/").pop()!.replace(/\.md$/, "") },
  }));
}

const { slug } = Astro.params;

// ✅ 3) 렌더링에서도 같은 객체 재사용
const loader = galleryModules[`/src/content/board/gallery/${slug}.md`];
if (!loader) throw new Error(`Gallery not found: ${slug}`);

const entry = await loader();
const { Content, frontmatter } = entry;

const imageUrls = toUrls(frontmatter.images);
const thumb = first(frontmatter.images);
---
