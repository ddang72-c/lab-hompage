---
import SectionLayout from "../../../layouts/SectionLayout.astro";
import type { MarkdownInstance } from "astro";

type ImageItem = string | { image: string };
type FM = { title?: string; date?: string; images?: ImageItem[]; summary?: string };

const toUrls = (imgs?: ImageItem[]) =>
  (imgs ?? []).map((v) => (typeof v === "string" ? v : v.image)).filter(Boolean);

export async function getStaticPaths() {
  const galleryModules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");

  return Object.keys(galleryModules).map((path) => ({
    params: { slug: path.split("/").pop()!.replace(/\.md$/, "") },
  }));
}

const { slug } = Astro.params;

// ⚠️ 여기서도 다시 선언(안전)
const galleryModules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");
const loader = galleryModules[`/src/content/board/gallery/${slug}.md`];

if (!loader) throw new Error(`Gallery not found: ${slug}`);

const entry = await loader();
const { Content, frontmatter } = entry;

const nav = [
  { label: "News", href: "/board/news/" },
  { label: "Gallery", href: "/board/gallery/" },
];

const imgs = toUrls(frontmatter.images);
---

<SectionLayout
  title={frontmatter.title ?? "Gallery"}
  sectionLabel="BOARD"
  navItems={nav}
  currentLabel="Gallery"
  heroImage="/images/sub-hero.jpg"
>
  <h1>{frontmatter.title ?? "Gallery"}</h1>

  {imgs.length > 0 && (
    <div class="gallery-detail-grid">
      {imgs.map((src) => (
        <a class="photo" href={src} target="_blank" rel="noreferrer">
          <img src={src} alt="" loading="lazy" />
        </a>
      ))}
    </div>
  )}

  <div class="gallery-body">
    <Content />
  </div>
</SectionLayout>
