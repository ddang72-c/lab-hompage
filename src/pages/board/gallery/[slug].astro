---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { MarkdownInstance } from "astro";

type ImageItem = string | { image: string };
type FM = { title: string; date?: string | Date; images?: ImageItem[] };

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");

export async function getStaticPaths() {
  const entries = await Promise.all(Object.values(modules).map((fn) => fn()));
  return entries.map((p) => ({
    params: { slug: p.file.split("/").pop()!.replace(/\.md$/, "") },
  }));
}

const { slug } = Astro.params;

const entry = await (modules[`/src/content/board/gallery/${slug}.md`] as any)();
const { Content, frontmatter } = entry;

const imageUrls =
  (frontmatter.images ?? [])
    .map((v) => (typeof v === "string" ? v : v.image))
    .filter(Boolean);
---

<BaseLayout title={frontmatter.title ?? "Gallery"}>
  <h1>{frontmatter.title ?? "Gallery"}</h1>

  {frontmatter.date && (
    <p class="muted" style="margin-top:-6px;">
      {new Date(frontmatter.date).toLocaleDateString()}
    </p>
  )}

  {imageUrls.length > 0 && (
    <div class="gallery-detail-grid">
      {imageUrls.map((src) => (
        <a class="photo" href={src} target="_blank" rel="noreferrer">
          <img src={src} alt={frontmatter.title ?? "photo"} loading="lazy" />
        </a>
      ))}
    </div>
  )}

  <div class="gallery-body">
    <Content />
  </div>
</BaseLayout>
