---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import type { MarkdownInstance } from "astro";

type ImageItem = string | { image: string };
type FM = { title: string; date?: string | Date; images?: ImageItem[] };

const first = (imgs?: ImageItem[]) => {
  const v = imgs?.[0];
  if (!v) return "";
  return typeof v === "string" ? v : v.image;
};

const toUrls = (imgs?: ImageItem[]) =>
  (imgs ?? [])
    .map((v) => (typeof v === "string" ? v : v.image))
    .filter(Boolean);

export async function getStaticPaths() {
  // ✅ getStaticPaths 내부에서 다시 선언 (Cloudflare 빌드 스코프 문제 방지)
  const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");
  const entries = await Promise.all(Object.values(modules).map((fn) => fn()));

  return entries.map((p) => ({
    params: { slug: p.file.split("/").pop()!.replace(/\.md$/, "") },
  }));
}

const { slug } = Astro.params;

// ✅ 페이지 렌더링에서도 다시 선언해서 안전하게 로드
const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/gallery/*.md");
const loader = modules[`/src/content/board/gallery/${slug}.md`];

if (!loader) throw new Error(`Gallery not found: ${slug}`);

const entry = await loader();
const { Content, frontmatter } = entry;

const imageUrls = toUrls(frontmatter.images);
const thumb = first(frontmatter.images);
---

<BaseLayout title={frontmatter.title ?? "Gallery"}>
  <h1>{frontmatter.title ?? "Gallery"}</h1>

  {frontmatter.date && (
    <p class="muted" style="margin-top:-6px;">
      {new Date(frontmatter.date).toLocaleDateString()}
    </p>
  )}

  {imageUrls.length > 0 && (
    <div class="gallery-detail-grid">
      {imageUrls.map((src) => (
        <a class="photo" href={src} target="_blank" rel="noreferrer">
          <img src={src} alt={frontmatter.title ?? "photo"} loading="lazy" />
        </a>
      ))}
    </div>
  )}

  <div class="gallery-body">
    <Content />
  </div>
</BaseLayout>
