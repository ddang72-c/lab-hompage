---
import SectionLayout from "../../../layouts/SectionLayout.astro";
import GalleryAlbum from "../../../components/gallery/GalleryAlbum.tsx";
import { stripFrontmatter, toImageUrls } from "../../../lib/board";
import type { MarkdownInstance } from "astro";

type FM = Record<string, any>;

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/news/*.md");

const posts = await Promise.all(
  Object.entries(modules).map(async ([, loader]) => {
    const entry = await loader();
    const fm = entry.frontmatter ?? {};

    const title = (fm.title ?? "Untitled").toString();
    const dateStr = (fm.date ?? fm.published ?? fm.created ?? "").toString();
    const date = dateStr ? new Date(dateStr) : null;

    const images = toImageUrls(fm);
    const fit = (fm.fit ?? "auto").toString();

    const Content = entry.Content;
    const hasBody = stripFrontmatter(entry.rawContent()).length > 0;

    return { title, date, images, fit, Content, hasBody };
  })
);

posts.sort((a, b) => {
  const ad = a.date ? a.date.getTime() : 0;
  const bd = b.date ? b.date.getTime() : 0;
  if (ad !== bd) return bd - ad;
  return a.title.localeCompare(b.title);
});

const fmt = (d: Date | null) => (d ? d.toISOString().slice(0, 10) : "");
---

<SectionLayout title="News">
  <style is:global>
    .news-wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px;
    }

    /* ✅ 간격(row-gap) 대신 "구분선 + 패딩"으로 */
    .news-list{
      display: grid !important;
      row-gap: 0 !important;
    }

    /* 각 게시물 위아래 여백 */
    .news-post{
      padding: 44px 0;
      border: 0;
    }

    /* ✅ 두 번째 게시물부터 얇은 회색선 */
    .news-post + .news-post{
      border-top: 1px solid #e5e5e5;
    }

    @media (max-width: 520px){
      .news-post{ padding: 34px 0; }
    }
  </style>

  <div class="news-wrap">
    <div class="news-list">
      {posts.map((p) => (
        <article class="news-post">
          <header class="gpost-header">
            <h2 class="gpost-title">{p.title}</h2>
            {p.date && <div class="gpost-date">{fmt(p.date)}</div>}
          </header>

          {p.images.length > 0 && (
            <GalleryAlbum
              client:load
              images={p.images}
              fit="contain"
              singleMaxWidth={620}
              singleMaxHeight={200}
              rowHeightScale={0.72}
              gapScale={0.9}
              align="left"
            />
          )}

          {p.hasBody && (
            <div class="gpost-body">
              <p.Content />
            </div>
          )}
        </article>
      ))}
    </div>
  </div>
</SectionLayout>
