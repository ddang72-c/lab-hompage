---
import SectionLayout from "../../../layouts/SectionLayout.astro";
import GalleryAlbum from "../../../components/gallery/GalleryAlbum.tsx";
import type { MarkdownInstance } from "astro";

type FM = Record<string, any>;

const stripFrontmatter = (raw: string) => raw.replace(/^---[\s\S]*?---\s*/m, "").trim();

const extractImagesFromBody = (body: string): string[] => {
  const out: string[] = [];

  // Markdown: ![alt](url)
  const mdRe = /!\[[^\]]*\]\(([^)]+)\)/g;
  for (const m of body.matchAll(mdRe)) {
    const url = (m[1] ?? "").trim().split(/\s+/)[0];
    if (url) out.push(url);
  }

  // HTML: <img src="...">
  const htmlRe = /<img[^>]+src=["']([^"']+)["']/g;
  for (const m of body.matchAll(htmlRe)) {
    const url = (m[1] ?? "").trim();
    if (url) out.push(url);
  }

  return Array.from(new Set(out));
};

const toImageUrls = (fm: any, body: string): string[] => {
  const out: string[] = [];
  const push = (x: any) => {
    if (typeof x === "string" && x.trim()) out.push(x.trim());
  };
  const readList = (arr: any[]) => {
    for (const it of arr) {
      if (typeof it === "string") push(it);
      else if (it && typeof it === "object") push(it.photo ?? it.image ?? it.src ?? it.url);
    }
  };

  // frontmatter 후보들
  if (Array.isArray(fm?.images)) readList(fm.images);
  if (Array.isArray(fm?.photos)) readList(fm.photos);
  if (Array.isArray(fm?.gallery)) readList(fm.gallery);
  if (Array.isArray(fm?.media)) readList(fm.media);
  if (Array.isArray(fm?.attachments)) readList(fm.attachments);

  push(fm?.cover);
  push(fm?.thumbnail);
  push(fm?.thumb);
  push(fm?.image);

  // ✅ 본문에 들어간 이미지까지 흡수
  for (const url of extractImagesFromBody(body)) out.push(url);

  return Array.from(new Set(out));
};

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/board/news/*.md");

const posts = await Promise.all(
  Object.entries(modules).map(async ([, loader]) => {
    const entry = await loader();
    const fm = entry.frontmatter ?? {};

    const title = (fm.title ?? "Untitled").toString();
    const dateStr = (fm.date ?? fm.published ?? fm.created ?? "").toString();
    const date = dateStr ? new Date(dateStr) : null;

    const body = stripFrontmatter(entry.rawContent());
    const images = toImageUrls(fm, body);
    const fit = (fm.fit ?? "auto").toString();

    const Content = entry.Content;
    const hasBody = body.length > 0;

    return { title, date, images, fit, Content, hasBody };
  })
);

posts.sort((a, b) => {
  const ad = a.date ? a.date.getTime() : 0;
  const bd = b.date ? b.date.getTime() : 0;
  if (ad !== bd) return bd - ad;
  return a.title.localeCompare(b.title);
});

const fmt = (d: Date | null) => (d ? d.toISOString().slice(0, 10) : "");
---

<SectionLayout title="News">
  <style is:global>
    :root{
      --kr-font: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    }

    .news-wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px;
    }

    .news-list{
      display: grid !important;
      row-gap: 100px !important;
    }

    .news-post{
      padding-bottom: 0;
      border-bottom: 0;
    }

    .gpost-header{
      text-align: left;
      margin-bottom: 18px;
    }
    .gpost-title{
      margin: 0;
      font-family: var(--kr-font);
      font-weight: 800;
      font-size: 30px;
      line-height: 1.12;
      letter-spacing: -0.02em;
    }
    .gpost-date{
      margin-top: 10px;
      font-family: var(--kr-font);
      font-size: 16px;
      color: var(--muted, #6b7280);
    }

    .gpost-body{
      margin-top: 18px;
      font-family: var(--kr-font);
      font-size: 17px;
      line-height: 1.85;
      color: var(--text, #111827);
    }
    .gpost-body :global(p){ margin: 0 0 12px 0; }
    .gpost-body :global(a){ text-decoration: underline; }

    @media (max-width: 900px){
      .news-list{ row-gap: 90px !important; }
      .gpost-title{ font-size: 36px; }
    }
    @media (max-width: 520px){
      .news-wrap{ padding: 0 14px; }
      .news-list{ row-gap: 72px !important; }
      .gpost-title{ font-size: 30px; }
      .gpost-body{ font-size: 16px; }
    }
  </style>

  <div class="news-wrap">
    <div class="news-list">
      {posts.map((p) => (
        <article class="news-post">
          <header class="gpost-header">
            <h2 class="gpost-title">{p.title}</h2>
            {p.date && <div class="gpost-date">{fmt(p.date)}</div>}
          </header>

          {p.images.length > 0 && (
            <GalleryAlbum client:load images={p.images} fit={p.fit} />
          )}

          {p.hasBody && (
            <div class="gpost-body">
              <p.Content />
            </div>
          )}
        </article>
      ))}
    </div>
  </div>
</SectionLayout>
