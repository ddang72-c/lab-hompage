---
import SectionLayout from "../../layouts/SectionLayout.astro";
import type { MarkdownInstance } from "astro";

type FM = {
  title?: string;
  Affiliation?: string;
  // ✅ joined를 새로 지원 + 기존 position도 호환
  joined?: string;
  position?: string;

  contact?: string;
  photo?: string;
  order?: number;
};

const modules = import.meta.glob<MarkdownInstance<FM>>("/src/content/people/students/*.md");

const entries = await Promise.all(
  Object.entries(modules).map(async ([path, loader]) => {
    const entry = await loader();
    return { path, entry };
  })
);

const asText = (v: unknown) =>
  typeof v === "string" ? v.trim() : v == null ? "" : String(v).trim();

const contactHref = (c: string) => {
  const t = c.trim();
  if (!t) return "";
  if (/^https?:\/\//i.test(t)) return t;
  if (t.includes("@")) return `mailto:${t}`;
  return t;
};

// order 오름차순 → title 오름차순
entries.sort((a, b) => {
  const ao = a.entry.frontmatter?.order ?? Number.POSITIVE_INFINITY;
  const bo = b.entry.frontmatter?.order ?? Number.POSITIVE_INFINITY;
  if (ao !== bo) return ao - bo;

  const at = asText(a.entry.frontmatter?.title);
  const bt = asText(b.entry.frontmatter?.title);
  return at.localeCompare(bt);
});
---

<SectionLayout title="Students">
  <style is:global>
    /* ✅ 구글 사이트 느낌: 폭 넓고, 카드도 크게 */
    .people-wrap {
      max-width: 1040px;
      margin: 0 auto;
      padding: 0 18px;
      margin-top: 24px;
    }

    .people-list {
      display: grid;
      gap: 22px;
    }

    /* 카드 테두리 없이 아래 구분선 + 여백 확대 */
    .people-card {
      display: flex;
      gap: 34px;
      align-items: flex-start;
      padding: 22px 0;
      border-bottom: 1px solid #eee;
    }

    /* ✅ 사진 크게 (세로 증명사진에 맞게) */
    .people-photo {
      width: 180px;
      height: 230px;
      object-fit: cover;
      object-position: 50% 15%; /* 머리 덜 잘리게 */
      border-radius: 0;
      flex: 0 0 auto;
      background: #f3f3f3;
    }

    .people-title {
      margin: 0;
      font-size: 2rem;
      font-weight: 800;
      line-height: 1.2;
    }

    .people-meta {
      margin: 14px 0 0 0;
      padding-left: 22px;
      line-height: 1.9;
      font-size: 1.05rem;
    }

    .people-meta li b {
      font-weight: 800;
    }

    .people-contact a {
      text-decoration: underline;
    }

    @media (max-width: 800px) {
      .people-card {
        gap: 18px;
      }
      .people-photo {
        width: 140px;
        height: 180px;
      }
      .people-title {
        font-size: 1.55rem;
      }
      .people-meta {
        font-size: 1rem;
      }
    }
  </style>

  <div class="people-wrap">
    <div class="people-list">
      {entries.map(({ entry }) => {
        const fm = entry.frontmatter ?? {};

        const title = asText(fm.title);
        const affiliation = asText(fm.Affiliation);

        // ✅ Joined 우선, 없으면 기존 position 사용(호환)
        const joined = asText(fm.joined ?? fm.position);

        const contact = asText(fm.contact);
        const photo = asText(fm.photo);

        const href = contactHref(contact);

        return (
          <article class="people-card">
            {photo && <img class="people-photo" src={photo} alt={title} loading="lazy" />}

            <div style="flex:1; min-width:0;">
              <h2 class="people-title">{title}</h2>

              {(affiliation || joined || contact) && (
                <ul class="people-meta">
                  {affiliation && (
                    <li>
                      <b>Affiliation :</b> {affiliation}
                    </li>
                  )}

                  {/* ✅ Position → Joined 라벨로 표시 */}
                  {joined && (
                    <li>
                      <b>Joined :</b> {joined}
                    </li>
                  )}

                  {contact && (
                    <li class="people-contact">
                      <b>Contact :</b>{" "}
                      {href ? (
                        <a href={href} target={href.startsWith("http") ? "_blank" : undefined} rel="noreferrer">
                          {contact}
                        </a>
                      ) : (
                        contact
                      )}
                    </li>
                  )}
                </ul>
              )}
            </div>
          </article>
        );
      })}

      {entries.length === 0 && <p class="muted">No student entries yet.</p>}
    </div>
  </div>
</SectionLayout>
