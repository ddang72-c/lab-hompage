---
const desktopNav = [
  {
    label: "PEOPLE",
    items: [
      { label: "Professor", href: "/people/professor/" },
      { label: "Students", href: "/people/students/" },
      { label: "Alumni", href: "/people/alumni/" },
    ],
  },
  {
    label: "RESEARCH",
    items: [
      { label: "Research area", href: "/research/research-area/" },
      { label: "Facilities", href: "/research/facilities/" },
    ],
  },
  {
    label: "PUBLICATION",
    items: [
      { label: "Journal", href: "/publication/journal/" },
      { label: "Conference", href: "/publication/conference/" },
    ],
  },
  {
    label: "BOARD",
    items: [
      { label: "News", href: "/board/news/" },
      { label: "Gallery", href: "/board/gallery/" },
    ],
  },
];

const mobileMenu = [
  {
    label: "PEOPLE",
    items: [
      { label: "Professor", href: "/people/professor/" },
      { label: "Students", href: "/people/students/" },
      { label: "Alumni", href: "/people/alumni/" },
    ],
  },
  {
    label: "RESEARCH",
    items: [
      { label: "Research area", href: "/research/research-area/" },
      { label: "Facilities", href: "/research/facilities/" },
    ],
  },
  {
    label: "PUBLICATION",
    items: [
      { label: "Journal", href: "/publication/journal/" },
      { label: "Conference", href: "/publication/conference/" },
    ],
  },
  {
    label: "BOARD",
    items: [
      { label: "News", href: "/board/news/" },
      { label: "Gallery", href: "/board/gallery/" },
    ],
  },
];
---

<header class="site-header">
  <div class="header-main">
    <ddiv class="header-main-inner header-main-inner--wide">
      <a class="brand" href="/">
        <img class="brand-logo" src="/images/pnu-logo.png" alt="PNU logo" />
      </a>

      <button class="nav-toggle" aria-label="open menu" aria-expanded="false" data-menu-open>
        ☰
      </button>

      <nav class="gnb" aria-label="Main navigation">
        <ul class="gnb-list">
          {desktopNav.map((group) => (
            <li class="gnb-item">
              <a class="gnb-link" href={group.items[0]?.href ?? "#"}>{group.label}</a>

              {group.items?.length ? (
                <ul class="dropdown">
                  {group.items.map((it) => (
                    <li class="dropdown-item">
                      <a href={it.href}>{it.label}</a>
                    </li>
                  ))}
                </ul>
              ) : null}
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </div>

  <div class="mobile-overlay" data-mobile-overlay aria-hidden="true">
    <div class="mobile-overlay-inner">
      <div class="mobile-topbar">
        <button class="mobile-close" aria-label="close menu" data-menu-close>✕</button>
      </div>

      <div class="mobile-card" role="dialog" aria-label="Mobile menu">
        {mobileMenu.map((g) => (
          <details class="mobile-group">
            <summary class="mobile-summary">
              <span class="mobile-summary-label">{g.label}</span>
              <span class="mobile-summary-caret">▾</span>
            </summary>

            <ul class="mobile-sub">
              {g.items.map((it) => (
                <li>
                  <a href={it.href}>{it.label}</a>
                </li>
              ))}
            </ul>
          </details>
        ))}
      </div>
    </div>
  </div>

  <script is:inline>
    const openBtn = document.querySelector("[data-menu-open]");
    const closeBtn = document.querySelector("[data-menu-close]");
    const overlay = document.querySelector("[data-mobile-overlay]");
    const card = overlay?.querySelector(".mobile-card");

    const BASE_VH = 60; 

    function updateOverlayHeight() {
      if (!overlay || !card) return;

      const basePx = (window.innerHeight * BASE_VH) / 100;
      const rect = card.getBoundingClientRect();

      const desired = rect.bottom + 24;

      const h = Math.max(basePx, desired);

      const clamped = Math.min(h, window.innerHeight);

      overlay.style.setProperty("--overlay-h", `${clamped}px`);
    }

    const openMenu = () => {
      overlay?.classList.add("is-open");
      overlay?.setAttribute("aria-hidden", "false");
      openBtn?.setAttribute("aria-expanded", "true");
      document.body.style.overflow = "hidden";

      requestAnimationFrame(updateOverlayHeight);
    };

    const closeMenu = () => {
      overlay?.classList.remove("is-open");
      overlay?.setAttribute("aria-hidden", "true");
      openBtn?.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";

      overlay?.style.removeProperty("--overlay-h");
    };

    openBtn?.addEventListener("click", openMenu);
    closeBtn?.addEventListener("click", closeMenu);

    const groups = overlay?.querySelectorAll("details.mobile-group");

    groups?.forEach((d) => {
      d.addEventListener("toggle", () => {
        if (d.open) {
          groups.forEach((other) => {
            if (other !== d) other.open = false;
          });
        }
        requestAnimationFrame(updateOverlayHeight);
      });
    });

    window.addEventListener("resize", () => {
      if (overlay?.classList.contains("is-open")) updateOverlayHeight();
    });

    overlay?.addEventListener("click", (e) => {
      if (e.target === overlay) closeMenu();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenu();
    });
  </script>
</header>
